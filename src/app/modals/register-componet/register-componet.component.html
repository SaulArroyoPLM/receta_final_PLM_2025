<ion-content class="registro-dialog-container">
  <div class="dialog-content">
    <div class="step-form-content">
      <!-- Custom Stepper -->
      <app-custom-stepper
        [steps]="steps"
        [currentStepIndex]="currentStep"
        [linear]="isLinear"
        [showNavigationButtons]="false"
        (stepChange)="onStepChange($event)"
        (stepClick)="onStepClick($event)"
        class="custom-stepper"
      >
        <!-- Contenido dinámico según el paso actual -->
        <div [ngSwitch]="currentStep" class="stepper-content-area">
          <!-- Paso 0: Datos Personales -->
          <ng-container *ngIf="currentStep === 0">
            <!-- Sub-pasos móviles -->
            <form [formGroup]="datosPersonalesForm" *ngIf="isMobile">
              <div class="mobile-substeps">
                <!-- Sub-paso 0: Información básica -->
                <div *ngIf="shouldShowMobileSubStepFields(0)" class="mobile-substep-card">
                  <h4>Información básica</h4>
                  <ion-grid>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Nombre(s)</mat-label>
                          <input matInput formControlName="nombre" placeholder="Ingresa tu nombre" class="inputs">
                          <mat-error *ngIf="datosPersonalesForm.get('nombre')?.hasError('required')">
                            El nombre es requerido
                          </mat-error>
                          <mat-error *ngIf="datosPersonalesForm.get('nombre')?.hasError('minlength')">
                            El nombre debe tener al menos 2 caracteres
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Primer apellido</mat-label>
                          <input matInput formControlName="primerApellido" placeholder="Primer apellido" class="inputs">
                          <mat-error *ngIf="datosPersonalesForm.get('primerApellido')?.hasError('required')">
                            Requerido
                          </mat-error>
                          <mat-error *ngIf="datosPersonalesForm.get('primerApellido')?.hasError('minlength')">
                            El apellido debe tener al menos 2 caracteres
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Segundo apellido</mat-label>
                          <input matInput formControlName="segundoApellido" placeholder="Segundo apellido" class="inputs">
                          <mat-error *ngIf="datosPersonalesForm.get('segundoApellido')?.hasError('required')">
                            Requerido
                          </mat-error>
                          <mat-error *ngIf="datosPersonalesForm.get('segundoApellido')?.hasError('minlength')">
                            El apellido debe tener al menos 2 caracteres
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Fecha de nacimiento</mat-label>
                          <input matInput [matDatepicker]="picker" formControlName="fechaNacimiento" class="inputs">
                          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                          <mat-datepicker #picker></mat-datepicker>
                          <mat-error *ngIf="datosPersonalesForm.get('fechaNacimiento')?.hasError('required')">
                            La fecha es requerida
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Estado</mat-label>
                          <mat-select formControlName="estado">
                            <mat-option *ngFor="let estado of estados" [value]="estado">
                              {{estado}}
                            </mat-option>
                          </mat-select>
                          <mat-error *ngIf="datosPersonalesForm.get('estado')?.hasError('required')">
                            Selecciona un estado
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                </div>

                <!-- Sub-paso 1: Contacto y acceso -->
                <div *ngIf="shouldShowMobileSubStepFields(1)" class="mobile-substep-card">
                  <h4>Contacto y acceso</h4>
                  <ion-grid>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Celular</mat-label>
                          <input matInput formControlName="celular" placeholder="Ingresa tu número de celular" class="inputs" type="tel">
                          <mat-error *ngIf="datosPersonalesForm.get('celular')?.hasError('required')">
                            Número de teléfono requerido
                          </mat-error>
                          <mat-error *ngIf="datosPersonalesForm.get('celular')?.hasError('pattern')">
                            Formato de teléfono inválido
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Correo electrónico</mat-label>
                          <input matInput formControlName="correo" placeholder="ejemplo@correo.com" type="email" class="inputs">
                          <mat-error *ngIf="datosPersonalesForm.get('correo')?.hasError('required')">
                            El correo es requerido
                          </mat-error>
                          <mat-error *ngIf="datosPersonalesForm.get('correo')?.hasError('email')">
                            Ingresa un correo válido
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Contraseña</mat-label>
                          <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="contrasena" placeholder="Mínimo 8 caracteres" class="inputs">
                          <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" type="button">
                            <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                          </button>
                          <mat-error>{{getPasswordErrors()}}</mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Confirmar contraseña</mat-label>
                          <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmarContrasena" placeholder="Confirma tu contraseña" class="inputs">
                          <button mat-icon-button matSuffix (click)="hideConfirmPassword = !hideConfirmPassword" type="button">
                            <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                          </button>
                          <mat-error>{{getConfirmPasswordErrors()}}</mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <div class="checkbox-container">
                          <mat-checkbox formControlName="terminosCondiciones" color="primary">
                            <span class="legal">He leído y aceptado los <a href="#" class="link">Términos y condiciones</a></span>
                          </mat-checkbox>
                          <mat-error *ngIf="datosPersonalesForm.get('terminosCondiciones')?.hasError('requiredTrue')" class="checkbox-error">
                            Debes aceptar los términos y condiciones
                          </mat-error>
                        </div>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                </div>
              </div>
            </form>

            <!-- Formulario completo para escritorio -->
            <form [formGroup]="datosPersonalesForm" *ngIf="!isMobile" class="desktop-form-content">
              <div class="form-title">
                <h3 class="title">Datos personales</h3>
                <p class="p_ingresa">Ingresa tus datos personales</p>
              </div>
              <ion-grid>
                <ion-row>
                  <ion-col size="12" size-lg="6">
                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Nombre(s)</mat-label>
                      <input matInput formControlName="nombre" placeholder="Ingresa tu nombre" class="inputs">
                      <mat-error *ngIf="datosPersonalesForm.get('nombre')?.hasError('required')">
                        El nombre es requerido
                      </mat-error>
                      <mat-error *ngIf="datosPersonalesForm.get('nombre')?.hasError('minlength')">
                        El nombre debe tener al menos 2 caracteres
                      </mat-error>
                    </mat-form-field>
                  </ion-col>
                  <ion-col size="12" size-lg="6">
                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Primer apellido</mat-label>
                      <input matInput formControlName="primerApellido" placeholder="Primer apellido" class="inputs">
                      <mat-error *ngIf="datosPersonalesForm.get('primerApellido')?.hasError('required')">
                        Requerido
                      </mat-error>
                      <mat-error *ngIf="datosPersonalesForm.get('primerApellido')?.hasError('minlength')">
                        El apellido debe tener al menos 2 caracteres
                      </mat-error>
                    </mat-form-field>
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col size="12" size-lg="6">
                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Segundo apellido</mat-label>
                      <input matInput formControlName="segundoApellido" placeholder="Segundo apellido" class="inputs">
                      <mat-error *ngIf="datosPersonalesForm.get('segundoApellido')?.hasError('required')">
                        Requerido
                      </mat-error>
                      <mat-error *ngIf="datosPersonalesForm.get('segundoApellido')?.hasError('minlength')">
                        El apellido debe tener al menos 2 caracteres
                      </mat-error>
                    </mat-form-field>
                  </ion-col>
                  <ion-col size="12" size-lg="6">
                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Celular</mat-label>
                      <input matInput formControlName="celular" placeholder="Ingresa tu número de celular" class="inputs" type="tel">
                      <mat-error *ngIf="datosPersonalesForm.get('celular')?.hasError('required')">
                        Número de teléfono requerido
                      </mat-error>
                      <mat-error *ngIf="datosPersonalesForm.get('celular')?.hasError('pattern')">
                        Formato de teléfono inválido
                      </mat-error>
                    </mat-form-field>
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col size="12" size-lg="6">
                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Correo electrónico</mat-label>
                      <input matInput formControlName="correo" placeholder="ejemplo@correo.com" type="email" class="inputs">
                      <mat-error *ngIf="datosPersonalesForm.get('correo')?.hasError('required')">
                        El correo es requerido
                      </mat-error>
                      <mat-error *ngIf="datosPersonalesForm.get('correo')?.hasError('email')">
                        Ingresa un correo válido
                      </mat-error>
                    </mat-form-field>
                  </ion-col>
                  <ion-col size="12" size-lg="6">
                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Contraseña</mat-label>
                      <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="contrasena" placeholder="Mínimo 8 caracteres" class="inputs">
                      <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" type="button">
                        <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                      </button>
                      <mat-error>{{getPasswordErrors()}}</mat-error>
                    </mat-form-field>
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col size="12" size-lg="6">
                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Confirmar contraseña</mat-label>
                      <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmarContrasena" placeholder="Confirma tu contraseña" class="inputs">
                      <button mat-icon-button matSuffix (click)="hideConfirmPassword = !hideConfirmPassword" type="button">
                        <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                      </button>
                      <mat-error>{{getConfirmPasswordErrors()}}</mat-error>
                    </mat-form-field>
                  </ion-col>
                  <ion-col size="12" size-lg="6">
                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Fecha de nacimiento</mat-label>
                      <input matInput [matDatepicker]="pickerDesktop" formControlName="fechaNacimiento" class="inputs">
                      <mat-datepicker-toggle matIconSuffix [for]="pickerDesktop"></mat-datepicker-toggle>
                      <mat-datepicker #pickerDesktop></mat-datepicker>
                      <mat-error *ngIf="datosPersonalesForm.get('fechaNacimiento')?.hasError('required')">
                        La fecha es requerida
                      </mat-error>
                    </mat-form-field>
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col size="12" size-lg="6">
                    <mat-form-field appearance="fill" class="form-field">
                      <mat-label>Estado</mat-label>
                      <mat-select formControlName="estado">
                        <mat-option *ngFor="let estado of estados" [value]="estado">
                          {{estado}}
                        </mat-option>
                      </mat-select>
                      <mat-error *ngIf="datosPersonalesForm.get('estado')?.hasError('required')">
                        Selecciona un estado
                      </mat-error>
                    </mat-form-field>
                  </ion-col>
                  <ion-col size="12" size-lg="6">
                    <div class="checkbox-container">
                      <mat-checkbox formControlName="terminosCondiciones" color="primary">
                        <span class="legal">He leído y aceptado los <a href="#" class="link">Términos y condiciones</a></span>
                      </mat-checkbox>
                      <mat-error *ngIf="datosPersonalesForm.get('terminosCondiciones')?.hasError('requiredTrue')" class="checkbox-error">
                        Debes aceptar los términos y condiciones
                      </mat-error>
                    </div>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </form>
          </ng-container>

          <!-- PASO 1: Verificación por Email -->
          <div *ngSwitchCase="1" class="step-content">
            <form [formGroup]="verificacionEmailForm" class="step-form" (ngSubmit)="nextStepCustom()">
              <h2 class="verification-title title">Te enviamos un código por correo</h2>
              <ion-grid>
                <ion-row>
                  <!-- Left side - Text -->
                  <ion-col size="12" size-lg="6">
                    <h2 class="verification-subtitle">Te enviamos un código por correo</h2>
                    <p class="verification-info">Ingresa el código de verificación <br> que enviamos a:</p>
                    <p class="email-display">{{ datosPersonalesForm.get('correo')?.value || 'tuCorreo@email.com' }}</p>
                    <!-- Code Input with Circles -->
                    <div class="code-input-container ion-margin-top">
                      <input
                        type="text"
                        class="code-input"
                        placeholder="000000"
                        maxlength="6"
                        formControlName="codigoVerificacionEmail"
                        (input)="onCodeInput($event)"
                        (keydown.enter)="nextStepCustom()"
                        autocomplete="off"
                      >
                    </div>
                    <!-- Mensajes de error -->
                    <div class="error-message" *ngIf="error || verificacionEmailForm.get('codigoVerificacionEmail')?.hasError('invalidCode')">
                      {{ error || 'El código ingresado no es válido.' }}
                    </div>
                    <div class="error-message" *ngIf="verificacionEmailForm.get('codigoVerificacionEmail')?.hasError('required')">
                      El código es requerido.
                    </div>
                    <div class="error-message" *ngIf="verificacionEmailForm.get('codigoVerificacionEmail')?.hasError('pattern')">
                      El código debe contener 6 dígitos.
                    </div>
                    <!-- Resend Code -->
                    <div class="resend-section ion-margin-top">
                      <ion-row class="ion-justify-content-center ion-align-items-center">
                        <ion-col size="auto">
                          <p class="resend-text">¿No recibiste el código?</p>
                        </ion-col>
                        <ion-col size="auto">
                          <ion-button
                            fill="clear"
                            color="primary"
                            (click)="reenviarCodigoEmail()"
                            [disabled]="isResendingEmail"
                            class="resend-button"
                          >
                            {{ isResendingEmail ? 'Reenviando...' : 'Reenviar código' }}
                          </ion-button>
                        </ion-col>
                      </ion-row>
                    </div>
                  </ion-col>
                  <!-- Right side - Image -->
                  <ion-col size="12" size-lg="6" class="ion-text-center ion-align-items-center">
                    <img src="./assets/images/registro_01.svg" alt="Verificación por email" class="verification-image">
                  </ion-col>
                </ion-row>
              </ion-grid>
            </form>
          </div>

          <!-- Paso 2: Datos Profesionales -->
          <ng-container *ngIf="currentStep === 2">
            <!-- Sub-pasos móviles -->
            <form [formGroup]="configuracionRecetaForm" *ngIf="isMobile">
              <div class="mobile-substeps">
                <!-- Sub-paso 0: Estudios -->
                <div *ngIf="shouldShowMobileSubStepFields(0)" class="mobile-substep-card">
                  <h4>Estudios</h4>
                  <ion-grid>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Número de cédula profesional</mat-label>
                          <input matInput formControlName="cedula_profesional" placeholder="Cédula profesional" maxlength="8" class="inputs">
                          <mat-error *ngIf="configuracionRecetaForm.get('cedula_profesional')?.hasError('required')">
                            Requerido
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Especialidad médica</mat-label>
                          <input type="text" matInput placeholder="Selecciona tu especialidad médica" [matAutocomplete]="autoEspecialidad" formControlName="especialidad_medica" class="inputs">
                          <mat-autocomplete #autoEspecialidad="matAutocomplete">
                            <mat-option *ngFor="let option of filteredEspecialidades | async" [value]="option">
                              {{ option }}
                            </mat-option>
                          </mat-autocomplete>
                          <mat-error *ngIf="configuracionRecetaForm.get('especialidad_medica')?.hasError('required')">
                            Requerido
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Institución que emite el título</mat-label>
                          <input matInput formControlName="institucion" placeholder="Institución que emite el título" class="inputs">
                          <mat-error *ngIf="configuracionRecetaForm.get('institucion')?.hasError('required')">
                            Institución que emite el título es requerido
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                </div>
                <!-- Sub-paso 1: Consultorio médico -->
                <div *ngIf="shouldShowMobileSubStepFields(1)" class="mobile-substep-card">
                  <h4>Consultorio médico</h4>
                  <ion-grid>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Nombre del consultorio</mat-label>
                          <input matInput formControlName="consultorio" placeholder="Nombre del consultorio" class="inputs">
                          <mat-error *ngIf="configuracionRecetaForm.get('consultorio')?.hasError('required')">
                            Nombre del consultorio es requerido
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Dirección del consultorio</mat-label>
                          <input matInput formControlName="direccion" placeholder="Dirección del consultorio" class="inputs">
                          <mat-error *ngIf="configuracionRecetaForm.get('direccion')?.hasError('required')">
                            Requerido
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size="12">
                        <mat-form-field appearance="fill" class="form-field">
                          <mat-label>Teléfono del consultorio</mat-label>
                          <input matInput type="tel" formControlName="telconsultorio" placeholder="10 dígitos" maxlength="10" class="inputs">
                          <mat-error *ngIf="configuracionRecetaForm.get('telconsultorio')?.hasError('required')">
                            Requerido
                          </mat-error>
                          <mat-error *ngIf="configuracionRecetaForm.get('telconsultorio')?.hasError('pattern')">
                            Debe contener 10 dígitos
                          </mat-error>
                        </mat-form-field>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                </div>
              </div>
            </form>

            <!-- Formulario completo para escritorio -->
          <form [formGroup]="configuracionRecetaForm" *ngIf="!isMobile" class="desktop-form-content">
  
  <!-- Sección de Estudios -->
  <div class="form-title">
    <h3 class="title">Estudios</h3>
    <p class="p_ingresa">Ingresa tus datos profesionales</p>
  </div>
  
  <ion-grid>
    <ion-row>
      <ion-col size="12" size-lg="6">
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Número de cédula profesional</mat-label>
          <input matInput formControlName="cedula_profesional" 
                 placeholder="Tu cédula será verificada con datos oficiales" 
                 maxlength="8" 
                 class="inputs">
          <mat-error *ngIf="configuracionRecetaForm.get('cedula_profesional')?.hasError('required')">
            Requerido
          </mat-error>
        </mat-form-field>
      </ion-col>
      
      <ion-col size="12" size-lg="6">
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Título profesional</mat-label>
          <input type="text" matInput 
                 placeholder="P. Ej. Medicina general, Pediatría, etc." 
                 [matAutocomplete]="autoEspecialidad" 
                 formControlName="especialidad_medica" 
                 class="inputs">
          <mat-autocomplete #autoEspecialidad="matAutocomplete">
            <mat-option *ngFor="let option of filteredEspecialidades | async" [value]="option">
              {{ option }}
            </mat-option>
          </mat-autocomplete>
          <mat-error *ngIf="configuracionRecetaForm.get('especialidad_medica')?.hasError('required')">
            Requerido
          </mat-error>
        </mat-form-field>
      </ion-col>
    </ion-row>
    
    <ion-row>
      <ion-col size="12">
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Institución que emite el título</mat-label>
          <input matInput formControlName="institucion" 
                 placeholder="Institución que emite el título" 
                 class="inputs">
          <mat-error *ngIf="configuracionRecetaForm.get('institucion')?.hasError('required')">
            Institución que emite el título es requerido
          </mat-error>
        </mat-form-field>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- Sección de Consultorios -->
  <div class="form-title">
    <h3 class="title">Consultorios</h3>
    <p class="p_ingresa">Ingresa la dirección y datos de contacto del consultorio</p>
  </div>
  
  <ion-grid>
    <ion-row>
      <ion-col size="12">
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Nombre del consultorio</mat-label>
          <input matInput formControlName="consultorio" 
                 placeholder="Nombre del consultorio" 
                 class="inputs">
          <mat-error *ngIf="configuracionRecetaForm.get('consultorio')?.hasError('required')">
            Nombre del consultorio es requerido
          </mat-error>
        </mat-form-field>
      </ion-col>
    </ion-row>
    
    <ion-row>
      <ion-col size="12" size-lg="8">
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Dirección del consultorio</mat-label>
          <input matInput formControlName="direccion" 
                 placeholder="Dirección del consultorio" 
                 class="inputs">
          <mat-error *ngIf="configuracionRecetaForm.get('direccion')?.hasError('required')">
            Requerido
          </mat-error>
        </mat-form-field>
      </ion-col>
      
      <ion-col size="12" size-lg="4">
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Teléfono</mat-label>
          <input matInput type="tel" formControlName="telconsultorio" 
                 placeholder="10 dígitos" 
                 maxlength="10" 
                 class="inputs">
          <mat-error *ngIf="configuracionRecetaForm.get('telconsultorio')?.hasError('required')">
            Requerido
          </mat-error>
          <mat-error *ngIf="configuracionRecetaForm.get('telconsultorio')?.hasError('pattern')">
            Debe contener 10 dígitos
          </mat-error>
        </mat-form-field>
      </ion-col>
    </ion-row>
  </ion-grid>
  
</form>
          </ng-container>

          <!-- PASO 3: Verificación KYC -->
          <div *ngSwitchCase="3" class="step-content">
            <form [formGroup]="verificacionKYCForm" class="step-form">
              <div class="form-title_tres">
                <h3 class="title">Verificación de Identidad</h3>
                <p class="p_ingresa">Usaremos reconocimiento facial para confirmar tu identidad.<br>
                  Activaremos tu cámara para que muestres tu rostro en tiempo real.</p>
              </div>

              <!-- SUB-PASO 0: SELECCIÓN DE VERIFICACIÓN -->
              <div *ngIf="kycCurrentSubStep === 0" class="kyc-selection">
                <!-- Verificación por identificación oficial -->
                <div class="KYC_INE">
                  <p class="p_KYC_INE">Verificación por identificación oficial</p>
                  <mat-card appearance="outlined" class="verification-card">
                    <mat-card-content>
                      <div class="card-step-number">1</div>
                      <div class="card-content">
                        <p class="card-description">
                          <span class="link-text" (click)="iniciarCargaINE()">Arrastra o haz clic para subir tu identificación</span>
                          o
                          <span class="link-text" (click)="iniciarCapturaFoto()">toma una foto</span>
                        </p>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>

                <!-- Verificación facial -->
                <div class="KYC_FACIAL">
                  <p class="p_KYC_FACIAL">Verificación facial</p>
                  <mat-card appearance="outlined" class="verification-card">
                    <mat-card-content>
                      <div class="card-step-number">2</div>
                      <div class="card-content">
                        <p class="card-description">Confirma tu identidad a través de una foto</p>
                     <button matButton="tonal" expand="block" color="primary" (click)="iniciarVerificacionFacial()" [disabled]="!documentoINE.uploaded" class="start-button" > Comenzar </button>

                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>

              <!-- SUB-PASO 1: CARGA DE DOCUMENTO INE -->
              <div *ngIf="kycCurrentSubStep === 1" class="kyc-document-upload">
                <div class="instructions-content">
                  <div class="instructions-list">
                    <h4>Instrucciones:</h4>
                    <div class="instruction-item">
                      <mat-icon>visibility</mat-icon>
                      <span class="instruction-item-span">Asegúrate de que los detalles sean nítidos y no estén cubiertos</span>
                    </div>
                    <div class="instruction-item">
                      <mat-icon>wb_sunny</mat-icon>
                      <span class="instruction-item-span">Busca un área bien iluminada</span>
                    </div>
                    <div class="instruction-item">
                      <mat-icon>crop_free</mat-icon>
                      <span class="instruction-item-span">Verifica que el documento esté dentro del encuadre</span>
                    </div>
                  </div>
                  <div class="instructions-image">
                    <img src="assets/images/KYC_INE.png" alt="Instrucciones de captura" class="instructions-image">
                    <button matButton="filled"
                      expand="block"
                      color="primary"
                      (click)="nextStepCustom()"
                      [disabled]="!configuracionRecetaForm.valid"
                    >
                      Subir documento
                    </button>
                  </div>
                </div>
              </div>

              <!-- SUB-PASO 2: CONFIRMACIÓN DEL DOCUMENTO INE -->
              <div *ngIf="kycCurrentSubStep === 2" class="kyc-document-confirmation">
                <div class="KYC_INE">
                  <p class="p_KYC_INE">Verificación por identificación oficial</p>
                  <mat-card appearance="outlined" class="verification-card">
                    <mat-card-content>
                      <div class="card-step-number">✔</div>
                      <div class="card-content">
                        <div *ngIf="documentoINE.uploaded" class="document-confirmation success">
                          <span class="confirmation-text">El documento INE se subió correctamente</span>
                        </div>
                        <div *ngIf="!documentoINE.uploaded" class="document-confirmation error">
                          <span class="confirmation-text">Continuando sin documento</span>
                        </div>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
                <!-- Verificación facial -->
                <div class="KYC_FACIAL">
                  <p class="p_KYC_FACIAL">Verificación facial</p>
                  <mat-card appearance="outlined" class="verification-card">
                    <mat-card-content>
                      <div class="card-step-number">2</div>
                      <div class="card-content">
                        <p class="card-description">Confirma tu identidad a través de una foto</p>
                        <button matButton="tonal" 
                          expand="block"
                          color="primary"
                          (click)="iniciarVerificacionFacial()"
                          class="start-button"
                        >
                          Comenzar
                        </button>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>

              <!-- SUB-PASO 3: VERIFICACIÓN FACIAL -->
              <div *ngIf="kycCurrentSubStep === 3" class="kyc-facial-verification">
                <!-- Instrucciones iniciales -->
                <div *ngIf="verificacionFacial.instructions" class="facial-instructions">
                  <div class="alets_varifacion_facial">
                    <mat-card class="alert-warning-card">
                      <div class="alert-content">
                        <div class="text-content">
                          <strong>Advertencia de fotosensibilidad</strong><br>
                          Esta prueba muestra luces de colores. Ten precaución si eres fotosensible
                        </div>
                        <mat-icon color="warn">warning</mat-icon>
                      </div>
                    </mat-card>
                  </div>
                  <div class="instructions-content">
                    <div class="instructions-list">
                      <h4>Instrucciones:</h4>
                      <div class="instruction-item">
                        <mat-icon>wb_sunny</mat-icon>
                        <span>Encuentra un área con buena iluminación</span>
                      </div>
                      <div class="instruction-item">
                        <mat-icon>face</mat-icon>
                        <span>Asegúrate de que tu torso y el fondo sean visibles</span>
                      </div>
                      <div class="instruction-item">
                        <mat-icon>visibility</mat-icon>
                        <span>Coloca la cámara a la altura de tus ojos</span>
                      </div>
                      <div class="instruction-item">
                        <mat-icon>info</mat-icon>
                        <span>Más sobre la verificación</span>
                      </div>
                    </div>
                    <div class="instructions-image">
                      <img src="assets/images/KYC_FACIAL.png" alt="Instrucciones de captura" class="instructions-image">
                   <button matButton="filled"
                        expand="block"
                        color="primary"
                        (click)="irDirectoAConfirmacionFinal()"
                      >
                        Iniciar captura
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- SUB-PASO 4: OMITIR VERIFICACIÓN -->
              <div *ngIf="kycCurrentSubStep === 4" class="kyc-omit-verification">
                <!-- Card de advertencia importante -->
                <div class="important-warning">
                  <mat-card class="warning-card">
                    <mat-card-content>
                      <div class="warning-content">
                        <div class="warning-text">
                          <h2 class="warning-title">⚠️ IMPORTANTE</h2>
                          <div class="warning-messages">
                            <p>Si omites este paso, no podrás enviar consultas a tus pacientes.</p>
                            <p>Solo tomará 2 minutos completar esta verificación.</p>
                            <p><strong>¡Es por tu seguridad y la de tus pacientes!</strong></p>
                          </div>
                        </div>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>

              <!-- SUB-PASO 5: CONFIRMACIÓN DEL DOCUMENTO FACIAL -->
              <div *ngIf="kycCurrentSubStep === 5" class="kyc-document-confirmation">
                <div class="KYC_INE">
                  <p class="p_KYC_INE">Verificación por identificación oficial</p>
                  <mat-card appearance="outlined" class="verification-card">
                    <mat-card-content>
                      <div class="card-step-number">✔</div>
                      <div class="card-content">
                        <div *ngIf="documentoINE.uploaded" class="document-confirmation success">
                          <span class="confirmation-text">El documento INE se subió correctamente</span>
                        </div>
                        <div *ngIf="!documentoINE.uploaded" class="document-confirmation error">
                          <span class="confirmation-text">Continuando sin documento</span>
                        </div>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
                <!-- Verificación facial -->
                <div class="KYC_FACIAL">
                  <p class="p_KYC_FACIAL">Verificación facial</p>
                  <mat-card appearance="outlined" class="verification-card">
                    <mat-card-content>
                      <div class="card-step-number">✔</div>
                      <div class="card-content">
                        <div *ngIf="verificacionFacial.completed" class="document-confirmation success">
                          <span class="confirmation-text">Rostro validado correctamente</span>
                          <span class="confirmation-text">¡Tu identidad ha sido verificada!</span>
                        </div>
                        <div *ngIf="!verificacionFacial.completed" class="document-confirmation error">
                          <span class="confirmation-text">No se pudo validar tu rostro</span>
                        </div>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>
            </form>
          </div>

          <!-- PASO 4: Finalizar -->
          <div *ngSwitchCase="4" class="step-content">
            <form [formGroup]="finalizarForm" class="step-form">
              <div class="form-title">
                <h3 class="title">Resumen</h3>
              </div>
              <!-- Resumen con Expansion Panel -->
              <mat-accordion multi="true">
                <!-- Datos de cuenta -->
                <mat-expansion-panel class="datos_table" [expanded]="true">
                  <mat-expansion-panel-header>
                    <mat-panel-title>Datos de cuenta</mat-panel-title>
                  </mat-expansion-panel-header>
                  <div class="resumen_datos">
                    <div class="resumen_dato">
                      <p><strong>Nombre:</strong></p>
                      <p>{{ resumenDatos.cuenta.nombre }} {{ resumenDatos.cuenta.primerApellido }} {{ resumenDatos.cuenta.segundoApellido }}</p>
                    </div>
                    <div class="resumen_dato">
                      <p><strong>Fecha de nacimiento:</strong></p>
                      <p>{{ resumenDatos.cuenta.fechaNacimiento | date }}</p>
                    </div>
                    <div class="resumen_dato">
                      <p><strong>Celular:</strong></p>
                      <p>{{ resumenDatos.cuenta.celular }}</p>
                    </div>
                    <div class="resumen_dato">
                      <p><strong>Correo electrónico:</strong></p>
                      <p>{{ resumenDatos.cuenta.correo }}</p>
                    </div>
                  </div>
                </mat-expansion-panel>
                <!-- Datos profesionales -->
                <mat-expansion-panel class="datos_table" [expanded]="true">
                  <mat-expansion-panel-header>
                    <mat-panel-title>Datos profesionales</mat-panel-title>
                  </mat-expansion-panel-header>
                  <div class="resumen_datos">
                    <div class="resumen_dato">
                      <p><strong>Cédula profesional:</strong></p>
                      <p>{{ resumenDatos.profesionales.cedula }}</p>
                    </div>
                    <div class="resumen_dato">
                      <p><strong>Título profesional:</strong></p>
                      <p>{{ resumenDatos.profesionales.titulo }}</p>
                    </div>
                    <div class="resumen_dato">
                      <p><strong>Institución:</strong></p>
                      <p>{{ resumenDatos.profesionales.institucion }}</p>
                    </div>
                  </div>
                </mat-expansion-panel>
                <!-- Datos del consultorio -->
                <mat-expansion-panel class="datos_table">
                  <mat-expansion-panel-header>
                    <mat-panel-title>Datos del consultorio</mat-panel-title>
                  </mat-expansion-panel-header>
                  <div class="resumen_datos">
                    <div class="resumen_dato">
                      <p><strong>Nombre:</strong></p>
                      <p>{{ resumenDatos.consultorio.nombre }}</p>
                    </div>
                    <div class="resumen_dato">
                      <p><strong>Dirección:</strong></p>
                      <p>{{ resumenDatos.consultorio.direccion }}</p>
                    </div>
                    <div class="resumen_dato">
                      <p><strong>Teléfono:</strong></p>
                      <p>{{ resumenDatos.consultorio.telefono }}</p>
                    </div>
                  </div>
                </mat-expansion-panel>
              </mat-accordion>
              <!-- Aviso -->
              <mat-card class="aviso_card">
                <div>
                  <p class="aviso_p">Revisa cuidadosamente tu Cédula Profesional y tu título profesional antes de continuar.<br>
                    <strong>Una vez guardados, no podrás editarlos.</strong></p>
                </div>
                <mat-icon color="warn" style="margin-right: 12px;">warning</mat-icon>
              </mat-card>
            </form>
          </div>
        </div>

        <!-- Botones de navegación -->
        <div class="stepper-navigation  ion-text-center" *ngIf="shouldShowNavigationButtons()">
          <!-- Botón Omitir (solo en Paso 3, sub-pasos 0-3) -->
          <div *ngIf="currentStep === 3 && deberaMostrarOmitir()">
          <button matButton="tonal"
              fill="clear"
              (click)="omitirPasoKYC()"
              class="omit-button"
            >
              Omitir paso
            </button>
          </div>
          <!-- Botón Atrás (no en Paso 4) -->
         <button matButton="outlined"
            *ngIf="currentStep !== 4"
            fill="outline"
            color="danger"
            [disabled]="isSubmitting"
            (click)="previousStepCustom()"
            class="btn-previous"
          >
            {{ getMobileBackButtonText() }}
          </button>
          <!-- Botón Siguiente/Finalizar -->
         <button matButton="filled"
            color="primary"
            [disabled]="isSubmitting || (isMobile && (currentStep === 0 || currentStep === 2) && !canProceedToNextMobileSubStep())"
            (click)="nextStepCustom()"
           class="btn-next"
          >
            {{ getMobileStepButtonText() }}
          </button>
        </div>
      </app-custom-stepper>
    </div>
  </div>
</ion-content>